#!/bin/bash -eu

main() {
  om -v

  metadata="${PWD}/env-state/metadata"

  config="${PWD}/paving/ci/configuration/${IAAS}/ops-manager.yml"
  updated_config="${PWD}/env-state/ops-manager.yml"

  if [ "${IAAS}" == "gcp" ]; then
    key="${PWD}/env-state/key"
    echo "${GCP_SERVICE_ACCOUNT_KEY}" > "${key}"

    bosh interpolate "${config}" \
      --var-file gcp_service_account_key="${key}" \
      --var project="$(cat "${metadata}" | yq -r .stable_config | jq -r .project)" \
      --var region="$(cat "${metadata}" | yq -r .stable_config | jq -r .region)" \
      --var zone="$(cat "${metadata}" | yq -r .stable_config | jq -r .availability_zones[0])" \
      --var vpc_subnet="$(cat "${metadata}" | yq -r .stable_config | jq -r .management_subnet_name)" \
      --var public_ip="$(cat "${metadata}" | yq -r .stable_config | jq -r .ops_manager_public_ip)" \
      --var tags="$(cat "${metadata}" | yq -r .stable_config | jq -r .ops_manager_tags)" \
      > "${updated_config}"

    rm "${key}"

  elif [ "${IAAS}" == "aws" ]; then
    bosh interpolate "${config}" \
      --var access_key="${AWS_ACCESS_KEY}" \
      --var secret_key="${AWS_SECRET_KEY}" \
      --var region="$(cat "${metadata}" | yq -r .stable_config | jq -r .region)" \
      --var zone="$(cat "${metadata}" | yq -r .stable_config | jq -r .availability_zones[0])" \
      --var vpc_subnet_id="$(cat "${metadata}" | yq -r .stable_config | jq -r .subnet_public_ids[0])" \
      --var public_ip="$(cat "${metadata}" | yq -r .stable_config | jq -r .ops_manager_public_ip)" \
      --var key_pair_name="$(cat "${metadata}" | yq -r .stable_config | jq -r .ops_manager_key_pair_name)" \
      --var security_group_ids="[$(cat "${metadata}" | yq -r .stable_config | jq -r .security_group_ops_manager_id)]" \
      --var iam_instance_profile_name="$(cat "${metadata}" | yq -r .stable_config | jq -r .ops_manager_iam_instance_profile_name)" \
      > "${updated_config}"

  elif [ "${IAAS}" == "azure" ]; then
    vars_file="${PWD}/env-state/vars-file"
    cat "${metadata}" | yq -r .stable_config | jq -r . > "${vars_file}"

    bosh interpolate "${config}" --vars-file "${vars_file}" > "${updated_config}"
  fi
}

main "$@"
